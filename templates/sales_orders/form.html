<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% if so %}Edit Sales Order{% else %}New Sales Order{% endif %}</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin: 0; }
    .container { max-width: 1200px; margin: 20px auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    h1 { margin: 0 0 16px; color:#333; }
    a.button, button { display: inline-block; padding: 8px 14px; background: #333; color: #fff; border: none; border-radius: 4px; cursor: pointer; text-decoration: none; }
    a.button:hover, button:hover { background: #555; }
    .row { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; }
    .row label { width: 150px; text-align: right; color: #555; }
    .row input, .row textarea { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .table-container { overflow-x: auto; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; min-width: 800px; }
    th, td { padding: 8px 12px; border: 1px solid #ddd; vertical-align: middle; }
    th { background: #f1f1f1; font-weight: bold; }
    td input { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 3px; font-size: 14px; box-sizing: border-box; }
    td input[type="number"] { text-align: right; }
    .line-total { font-weight: bold; }
    .remove-btn { background: #dc3545; font-size: 12px; }
    .duplicate-btn { background: #17a2b8; font-size: 12px; margin-left: 4px; }
    .search-box { position: relative; }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ddd; max-height: 240px; overflow-y: auto; display: none; z-index: 1000; }
    .search-results div { padding: 8px; cursor: pointer; }
    .search-results div:hover { background: #f1f1f1; }
    .totals-section { margin-top: 20px; display: flex; justify-content: flex-end; }
    .totals-box { background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; padding: 15px; min-width: 300px; }
    .total-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .total-row:last-child { margin-bottom: 0; font-size: 16px; font-weight: bold; border-top: 1px solid #ddd; padding-top: 8px; }
    .top-buttons { display:flex; gap:10px; }
  </style>
</head>
<body>
<div class="container">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <h1>{% if so %}Edit Sales Order{% else %}New Sales Order{% endif %}</h1>
    <div class="top-buttons">
      <a href="javascript:history.back()" class="button" style="background:#6c757d;">‚Üê Back</a>
      <a href="/dashboard" class="button" style="background:#007bff;">üè† Dashboard</a>
      {% if so %}
        <a href="/sales_order/{{ so.id }}/pdf" class="button" style="background:#17a2b8;">üìÑ PDF</a>
        <a href="/sales_order/{{ so.id }}/print" target="_blank" class="button" style="background:#28a745;">üñ®Ô∏è Print</a>
      {% endif %}
    </div>
  </div>

  <form method="POST">
    <!-- Customer -->
    <div class="row">
      <label>Customer</label>
      <div class="search-box" style="flex:1;">
        <input type="text" id="customerSearch" placeholder="Search customer..." value="{{ so.customer_name if so else '' }}">
        <input type="hidden" name="customer_id" id="customerId" value="{{ so.customer_id if so else '' }}">
        <div class="search-results" id="customerResults"></div>
      </div>
    </div>

    <div class="row">
      <label>Date</label>
      <input type="date" name="date" value="{{ so.date if so else date_today }}">
    </div>
    <div class="row">
      <label>Expected Delivery</label>
      <input type="date" name="expected_delivery_date" value="{{ so.expected_delivery_date if so else '' }}">
    </div>
    <div class="row">
      <label>SO No</label>
      <input type="text" name="so_no" value="{{ so.so_no if so else '' }}" placeholder="Auto-generated if empty">
    </div>
    <div class="row">
      <label>Notes</label>
      <textarea name="notes">{{ so.notes if so else '' }}</textarea>
    </div>

    <!-- Line Items -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Item</th>
            <th>Qty</th>
            <th>Rate (‚Çπ)</th>
            <th>Discount (%)</th>
            <th>Line Total (‚Çπ)</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="lines"></tbody>
      </table>
    </div>
    <div style="margin-top:12px;">
      <button type="button" onclick="addRow()">+ Add Line Item</button>
    </div>

    <!-- Totals -->
    <div class="totals-section">
      <div class="totals-box">
        <div class="total-row"><span>Sub Total:</span><span>‚Çπ <span id="total">0.00</span></span></div>
        <div class="total-row"><span>Grand Total:</span><span>‚Çπ <span id="grand_total">0.00</span></span></div>
      </div>
    </div>

    <div style="margin-top:20px;">
      <button type="submit" style="background:#28a745;padding:12px 24px;font-size:16px;">üíæ Save Sales Order</button>
    </div>
  </form>
</div>

<script>
/* Customer Search */
async function searchCustomers(query, page=1) {
  const baseUrl = `${window.location.protocol}//${window.location.hostname}:5010`;
  const res = await fetch(`${baseUrl}/api/customers/search?q=${encodeURIComponent(query)}&page=${page}&limit=10`);
  return await res.json();
}

document.getElementById('customerSearch').addEventListener('input', async (e) => {
  const q = e.target.value.trim();
  const resultsBox = document.getElementById('customerResults');
  resultsBox.innerHTML = '';
  if (q.length < 2) { resultsBox.style.display = 'none'; return; }
  const data = await searchCustomers(q);
  if (!data || !data.results) return;
  data.results.forEach(c => {
    const div = document.createElement('div');
    div.textContent = `${c.name}${c.email ? ' ('+c.email+')' : ''}`;
    div.onclick = () => {
      document.getElementById('customerId').value = c.id;
      document.getElementById('customerSearch').value = c.name;
      resultsBox.style.display = 'none';
    };
    resultsBox.appendChild(div);
  });
  resultsBox.style.display = data.results.length ? 'block' : 'none';
});

/* Item Search */
async function searchItems(query, page=1) {
  const baseUrl = `${window.location.protocol}//${window.location.hostname}:5010`;
  const res = await fetch(`${baseUrl}/api/items/search/sales?q=${encodeURIComponent(query)}&page=${page}&limit=10`);
  return await res.json();
}

function createItemSearch(row, prefName='', prefId='', prefSku='') {
  const div = document.createElement('div');
  div.className = 'search-box';

  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = 'Search item by name or SKU...';
  input.value = prefName || (prefSku ? `[${prefSku}]` : '');

  const hidden = document.createElement('input');
  hidden.type = 'hidden';
  hidden.name = 'item_id[]';
  hidden.value = prefId;

  const results = document.createElement('div');
  results.className = 'search-results';

  div.appendChild(input);
  div.appendChild(hidden);
  div.appendChild(results);

  input.addEventListener('input', async (e) => {
    const q = e.target.value.trim();
    results.innerHTML = '';
    if (q.length < 2) { 
      results.style.display = 'none'; 
      return; 
    }

    try {
      const data = await searchItems(q);
      // ‚úÖ handle both {results:[...]} and [...] formats
      const resultsData = Array.isArray(data) ? data : (data.results || []);

      resultsData.forEach(it => {
        const d = document.createElement('div');
        d.textContent = `${it.name} [${it.sku}]`;
        d.onclick = () => {
          input.value = `${it.name} [${it.sku}]`;
          hidden.value = it.id;
          row.querySelector('[name="rate[]"]').value = it.selling_price || 0;
          row.querySelector('[name="discount[]"]').value = it.discount || 0;
          row.querySelector('[name="qty[]"]').title =
            `Available stock: ${it.stock_qty} ${it.uom||'Nos'}`;
          results.style.display = 'none';
          calcTotals();
        };
        results.appendChild(d);
      });

      results.style.display = resultsData.length ? 'block' : 'none';
    } catch (err) {
      console.error("Item search failed:", err);
      results.style.display = 'none';
    }
  });

  return div;
}


function addRow(pref={}) {
  const tbody = document.getElementById('lines');
  const tr = document.createElement('tr');
  const tdItem = document.createElement('td');
  tdItem.appendChild(createItemSearch(tr, pref.item_name||'', pref.item_id||'', pref.item_sku||'')); tr.appendChild(tdItem);
  const tdQty = document.createElement('td'); tdQty.innerHTML=`<input type="number" step="0.01" name="qty[]" value="${pref.qty||1}" required>`; tr.appendChild(tdQty);
  const tdRate = document.createElement('td'); tdRate.innerHTML=`<input type="number" step="0.01" name="rate[]" value="${pref.rate||0}" required>`; tr.appendChild(tdRate);
  const tdDisc = document.createElement('td'); tdDisc.innerHTML=`<input type="number" step="0.01" name="discount[]" value="${pref.discount||0}">`; tr.appendChild(tdDisc);
  const tdTotal = document.createElement('td'); tdTotal.innerHTML=`<span class="line-total">0.00</span>`; tr.appendChild(tdTotal);
  const tdAct = document.createElement('td'); tdAct.innerHTML = `
    <button type="button" class="remove-btn">Remove</button>
    <button type="button" class="duplicate-btn">Duplicate</button>
  `;
  tdAct.querySelector('.remove-btn').onclick = ()=>{ tr.remove(); calcTotals(); };
  tdAct.querySelector('.duplicate-btn').onclick = ()=>{ 
    const rowData = {
      item_name: tr.querySelector('input[type="text"]').value,
      item_id: tr.querySelector('input[type="hidden"]').value,
      qty: tr.querySelector('[name="qty[]"]').value,
      rate: tr.querySelector('[name="rate[]"]').value,
      discount: tr.querySelector('[name="discount[]"]').value
    };
    addRow(rowData);
  };
  tr.appendChild(tdAct);
  tbody.appendChild(tr);
  calcTotals();
}

(function(){
  'use strict';

  // -- safe parsing for decimals (accepts "1.2" and "1,2")
  function toNumber(val) {
    if (val === null || val === undefined) return 0;
    val = String(val).trim().replace(/,/g, '.');
    var n = parseFloat(val);
    return Number.isFinite(n) ? n : 0;
  }

  // -- calculate totals for all rows and update UI
  function calcTotals() {
    var total = 0;
    var rows = document.querySelectorAll('#lines tr');
    rows.forEach(function(tr){
      var qtyEl = tr.querySelector('[name="qty[]"]');
      var rateEl = tr.querySelector('[name="rate[]"]');
      var discEl = tr.querySelector('[name="discount[]"]');

      var qty = toNumber(qtyEl ? qtyEl.value : 0);
      var rate = toNumber(rateEl ? rateEl.value : 0);
      var disc = toNumber(discEl ? discEl.value : 0);

      var base = qty * rate;
      var lineTotal = Math.max(base * (1 - disc / 100), 0);
      total += lineTotal;

      var lineCell = tr.querySelector('.line-total');
      if (lineCell) {
        lineCell.textContent = lineTotal.toFixed(2);
      } else {
        // if your row template doesn't include .line-total, create one (keeps table consistent)
        var td = document.createElement('td');
        td.className = 'line-total';
        td.textContent = lineTotal.toFixed(2);
        tr.appendChild(td);
      }
    });

    var totalEl = document.getElementById('total');
    var grandEl = document.getElementById('grand_total');
    if (totalEl) totalEl.textContent = total.toFixed(2);
    if (grandEl) grandEl.textContent = total.toFixed(2);
  }

  // -- event delegation: recalc when qty/rate/discount inputs change
  document.addEventListener('input', function(e){
    var el = e.target;
    if (!el) return;
    var name = el.getAttribute('name');
    if (name === 'qty[]' || name === 'rate[]' || name === 'discount[]') {
      calcTotals();
    }
  });

  // -- Load initial lines (safe, won't throw if Jinja outputs bad JSON)
  try {
    var initialLines = {{ (lines or [])|tojson|safe }};
    if (Array.isArray(initialLines) && initialLines.length) {
      // addRow must be defined above this script; if not, skip and calc once
      initialLines.forEach(function(li){
        if (typeof addRow === 'function') {
          addRow({
            item_name: li.item_name || '',
            item_id: li.item_id || '',
            item_sku: li.item_sku || '',
            qty: li.qty !== null && li.qty !== undefined ? li.qty : 0,
            rate: li.rate !== null && li.rate !== undefined ? li.rate : 0,
            discount: li.discount !== null && li.discount !== undefined ? li.discount : 0
          });
        }
      });
    } else {
      // if no initial lines, ensure at least one row shows up
      if (typeof addRow === 'function' && document.querySelectorAll('#lines tr').length === 0) {
        addRow({});
      }
    }
  } catch (err) {
    console.error('Failed to load initialLines:', err);
  }

  // Run one initial calculation after a slight delay (ensures rows are present)
  window.addEventListener('DOMContentLoaded', function(){ setTimeout(calcTotals, 50); });

  // Expose for debugging in console
  window.calcTotals = calcTotals;
  window.toNumber = toNumber;
})();

</script>
</body>
</html>
